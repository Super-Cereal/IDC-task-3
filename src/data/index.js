let activityPageParser=t=>{let r=t.getCurrentSprint();var e={alias:"activity",data:{title:"Коммиты, 1 неделя",subtitle:`Спринт "${r.name}"`,data:{sun:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mon:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],tue:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],wed:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],thu:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],fri:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],sat:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}};let a=e.data.data,i=t.getCurrentCommits();return i.forEach(t=>{var e=t.timestamp-r.startAt,t=Math.floor(e/864e5),e=Math.floor(e%864e5/36e5);0===t?a.sun[e]++:1===t?a.mon[e]++:2===t?a.tue[e]++:3===t?a.wed[e]++:4===t?a.thu[e]++:5===t?a.fri[e]++:6===t&&a.sat[e]++}),e},chartPageParser=(r,t)=>{let a=r.getCurrentSprint();t={alias:"chart",data:{title:"Коммиты",subtitle:`Спринт "${a.name}"`,users:t,values:[]}};let i=r.getCurrentCommits(),s=t.data.values,e=r.getAllSprints();return e.forEach(t=>{let e={title:t.id,hint:t.name};t.id===a.id?(e.value=i.length,e.active=!0):e.value=r.getSprintCommits(t).length,s.push(e)}),t},diagramPageParser=e=>{var t=e.getCurrentSprint();let r={alias:"diagram",data:{title:"Размер коммитов",subtitle:`Спринт "${t.name}"`,totalText:"",differenceText:"",categories:[{title:"> 1001 строки",valueText:"",differenceText:""},{title:"501 — 1000 строк",valueText:"",differenceText:""},{title:"101 — 500 строк",valueText:"",differenceText:""},{title:"1 — 100 строк",valueText:"",differenceText:""}]}};function a(t,e){let r=t.getAllSummaries(),a=t.getSprintCommits(e),i=[0,0,0,0];return a.forEach(t=>{let e=0;t.summaries.forEach(t=>{t=t.id??t;e+=r[t].added+r[t].removed}),1001<=e?i[0]++:501<=e?i[1]++:101<=e?i[2]++:1<=e&&i[3]++}),i}var i=t=>t.reduce((t,e)=>t+e),s=e.getSprintById(t.id-1),n=a(e,s),u=a(e,t);o=e.getNoun(i(u),"коммит","коммита","коммитов"),r.data.totalText=`${i(u)} ${o}`;i=i(u)-i(n);r.data.differenceText=`${0<=i?"+":""}${i} с прошлого спринта`;for(let t=0;t<4;t++){o=e.getNoun(u[t],"коммит","коммита","коммитов"),r.data.categories[t].valueText=`${u[t]} ${o}`;var l=u[t]-n[t],o=e.getNoun(l,"коммит","коммита","коммитов");r.data.categories[t].differenceText=`${0<=l?"+":""}${l} коммитов`}return r},prepareData=(t,{sprintId:e})=>{var r=new ControlPanel(t,e),t=leadersPageParser(r),e=votePageParser(r);return[t,e,{...e,alias:"leaders"},chartPageParser(r,t.data.users),diagramPageParser(r),activityPageParser(r)]},leadersPageParser=t=>{let e={alias:"leaders",data:{title:"Больше всего коммитов",subtitle:`Спринт "${t.getCurrentSprint().name}"`,emoji:"👑",users:[]}};var r,a=t.getCurrentCommits(),i=t.countUsersCommits(a),s=t.getAllUsers();for(r in s){var n=t.getNoun(i[r],"коммит","коммита","коммитов"),n={...s[r],valueText:`${i[r]} ${n}`};e.data.users.push(n)}return e.data.users.sort((t,e)=>Number(e.valueText.split(" ")[0])-Number(t.valueText.split(" ")[0])),e},votePageParser=r=>{var t=r.getCurrentSprint();let e={alias:"vote",data:{title:"Самый 🔎 внимательный разработчик",subtitle:`Спринт "${t.name}"`,emoji:"🔎",offset:0,users:[]}};var a,i=r.getAllUsers(),s=r.countLikesToUsers(t);for(a in s){var n={...i[a],valueText:s[a]};e.data.users.push(n)}return e.data.users.sort((t,e)=>e.valueText-t.valueText),e.data.users=e.data.users.map(t=>{var e=r.getNoun(t.valueText,"голос","голоса","голосов");return{...t,valueText:`${t.valueText} ${e}`}}),e};const ControlPanel=class{constructor(t,e){this._sortEntities(t),this._sprintId=e,this._currentSprint=this.getSprintById(e),this._currentCommits=this.getSprintCommits(this._currentSprint),this._undefinedSprint={startAt:-1,finishAt:-1}}_sortEntities(t){this._entities={User:{},Project:[],Sprint:[],Commit:[],Summary:{},Issue:[],Comment:[]},t.forEach(t=>{switch(t.type){case"User":this._entities.User[t.id]={id:t.id,name:t.name,avatar:t.avatar,valueText:""};break;case"Summary":this._entities.Summary[t.id]=t;break;default:this._entities[t.type].push(t)}}),this._entities.Commit.sort((t,e)=>t.timestamp-e.timestamp),this._entities.Sprint.sort((t,e)=>t.startAt-e.startAt)}getCurrentSprint(){return this._currentSprint}getCurrentCommits(){return this._currentCommits}getAllUsers(){return this._entities.User}getAllSummaries(){return this._entities.Summary}getAllSprints(){return this._entities.Sprint}getSprintById(t){var e,r=this._entities.Sprint;for(e in r)if(r[e].id===t)return r[e];return this._undefinedSprint}getSprintCommits(t){var{startAt:e,finishAt:t}=t;let r=this._entities.Commit;e=this._getSprintCommitsBinSearch(r,e,"left"),t=this._getSprintCommitsBinSearch(r,t,"right");return r.slice(e,t+1)}_getSprintCommitsBinSearch(t,e,r){let a,i,s;switch(r){case"left":for(a=-1,i=t.length;1<i-a;)s=Math.floor((i+a)/2),t[s].timestamp<e?a=s:i=s;return i;case"right":for(a=0,i=t.length;1<i-a;)s=Math.floor((i+a)/2),t[s].timestamp<=e?a=s:i=s;return a}}countUsersCommits(t){let e={};return t.forEach(t=>{t=t.author.id??t.author;t in e?e[t]+=1:e[t]=1}),e}countLikesToUsers(t){let{startAt:r,finishAt:a}=t,e=this._entities.Comment,i={};return e.forEach(t=>{var e;r<=t.createdAt&&t.createdAt<=a&&((e=t.author.id??t.author)in i?i[e]+=(t.likes??[]).length:i[e]=(t.likes??[]).length)}),i}getNoun(t,e,r,a){let i=Math.abs(t);return i%=100,5<=i&&i<=20?a:(i%=10,1===i?e:2<=i&&i<=4?r:a)}};module.exports={prepareData:prepareData};
//# sourceMappingURL=index.js.map
